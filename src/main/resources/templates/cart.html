<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <meta name="username" th:content="${username}"/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Корзина | ЗАО Муром</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #2E7D32;
            --primary-light: #4CAF50;
            --primary-dark: #1B5E20;
            --secondary: #FF5722;
            --background: #f5f5f5;
            --surface: #ffffff;
            --error: #d32f2f;
            --text-primary: #212121;
            --text-secondary: #757575;
            --border: #e0e0e0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.1);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Header */
        .app-header {
            background-color: var(--primary);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-header__title {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .app-header__menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .app-header__menu-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Sidebar */
        .app-sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1000;
            top: 0;
            right: 0;
            background-color: var(--surface);
            overflow-x: hidden;
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
        }

        .app-sidebar--open {
            width: 320px;
        }

        .app-sidebar__header {
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .app-sidebar__close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .app-sidebar__nav {
            padding: 1rem 0;
        }

        .app-sidebar__nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: var(--transition);
        }

        .app-sidebar__nav-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--primary);
        }

        .app-sidebar__nav-item i {
            margin-right: 1rem;
            width: 24px;
            text-align: center;
        }

        /* Main container */
        .app-container {
            max-width: 1440px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
            }
        }

        /* Cart section */
        .cart-section {
            background-color: var(--surface);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .cart-section__header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .cart-section__actions {
            display: flex;
            gap: 1rem;
        }

        .cart-section__title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .distribution-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            background-color: var(--secondary);
            border: none;
            border-radius: var(--radius-md);
            color: white;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .distribution-btn:hover {
            background-color: #e64a19;
            box-shadow: var(--shadow-sm);
        }

        .cart-empty {
            padding: 3rem 2rem;
            text-align: center;
            color: var(--text-secondary);
        }

        .cart-empty__icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--border);
        }

        .cart-empty__text {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .cart-empty__btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary);
            color: white;
            border-radius: var(--radius-md);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

        .cart-empty__btn:hover {
            background-color: var(--primary-dark);
            box-shadow: var(--shadow-sm);
        }

        /* Truck block */
        .truck-block {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .truck-block__header {
            background-color: var(--primary-light);
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 500;
            display: flex;
            align-items: center;
        }

        .truck-block__icon {
            margin-right: 0.75rem;
        }

        /* Product item */
        .product-item {
            display: flex;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
        }

        .product-item:last-child {
            border-bottom: none;
        }

        .product-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .product-item__image {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            margin-right: 1.5rem;
            flex-shrink: 0;
        }

        .product-item__details {
            flex-grow: 1;
        }

        .product-item__name {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .product-item__description {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }

        .product-item__spec {
            display: inline-block;
            margin-right: 1rem;
            font-size: 0.875rem;
        }

        .product-item__price {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin: 0.75rem 0;
        }

        .product-item__actions {
            display: flex;
            align-items: center;
            margin-top: 1rem;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .quantity-control__btn {
            width: 36px;
            height: 36px;
            background-color: var(--background);
            border: none;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .quantity-control__btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .quantity-control__value {
            width: 50px;
            text-align: center;
            font-weight: 500;
        }

        .product-item__delete-btn {
            margin-left: 1rem;
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            transition: var(--transition);
        }

        .product-item__delete-btn:hover {
            background-color: rgba(211, 47, 47, 0.1);
        }

        .product-item__delete-icon {
            margin-right: 0.25rem;
        }

        /* Checkout section */
        .checkout-section {
            background-color: var(--surface);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
            position: sticky;
            top: 1rem;
        }

        .checkout-section__title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.9375rem;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.875rem 1.5rem;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 500;
            line-height: 1;
            color: white;
            background-color: var(--primary);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            text-decoration: none;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            box-shadow: var(--shadow-sm);
        }

        .btn--secondary {
            background-color: var(--secondary);
        }

        .btn--secondary:hover {
            background-color: #e64a19;
        }

        .btn i {
            margin-right: 0.5rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .app-container {
                padding: 0 1rem;
                margin: 1rem auto;
            }

            .product-item {
                flex-direction: column;
            }

            .product-item__image {
                width: 100%;
                height: auto;
                margin-right: 0;
                margin-bottom: 1rem;
            }

            .cart-section__header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Manual distribution modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: var(--surface);
            margin: 2rem auto;
            padding: 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            flex-grow: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .distribution-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            height: 100%;
            overflow: hidden;
        }

        .distribution-source {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
            height: 100%;
            overflow-y: auto;
        }

        .distribution-target {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .distribution-source h4, .distribution-target h4 {
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .product-list, .trucks-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 200px;
        }

        .trucks-container {
            overflow-y: auto;
            flex-grow: 1;
        }

        .distribution-item {
            background-color: var(--background);
            padding: 0.75rem;
            border-radius: var(--radius-sm);
            cursor: move;
            user-select: none;
        }

        .distribution-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .distribution-item-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .distribution-item__name {
            font-weight: 500;
        }

        .distribution-item__actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .distribution-item__quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-input {
            width: 50px;
            text-align: center;
            padding: 0.25rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
        }

        .split-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .split-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--primary);
        }

        .split-btn i {
            font-size: 14px;
        }

        .truck {
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .truck-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .truck-header i {
            cursor: pointer;
            color: var(--error);
        }

        .truck-products {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 50px;
            padding: 0.5rem;
            background-color: rgba(0, 0, 0, 0.02);
            border-radius: var(--radius-sm);
        }

        .btn--small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Drag and drop styles */
        .dragging {
            opacity: 0.5;
            transform: scale(1.02);
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .dropzone {
            border: 2px dashed var(--primary-light);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .dropzone-hover {
            border-color: var(--primary) !important;
            background-color: rgba(76, 175, 80, 0.2) !important;
        }

        .loading, .empty, .error {
            padding: 2rem;
            text-align: center;
            color: var(--text-secondary);
        }

        .loading i, .empty i {
            font-size: 2rem;
            margin-bottom: 1rem;
            display: block;
        }

        .error {
            color: var(--error);
        }

        .auto-distribute-btn {
            margin-top: 1rem;
            background-color: var(--primary-light);
        }

        .auto-distribute-btn:hover {
            background-color: var(--primary);
        }

        .trucks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .trucks-header h4 {
            margin: 0;
        }

        .auto-distribute-btn {
            margin: 0;
            padding: 0.35rem 0.75rem;
            font-size: 0.875rem;
            background-color: var(--primary-light);
            white-space: nowrap;
        }

        .auto-distribute-btn i {
            margin-right: 0.35rem;
        }

        /* Order summary styles */
        .order-summary {
            background-color: var(--surface);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .order-summary__header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .order-summary__header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .order-summary__total {
            display: flex;
            justify-content: space-between;
            font-size: 1.125rem;
            font-weight: 600;
        }

        .checkout-total {
            color: var(--primary-dark);
            font-weight: 700;
        }
    </style>
</head>
<body>
<header class="app-header">
    <div class="app-header__title">
        ЗАО Муром
    </div>
    <button class="app-header__menu-btn" onclick="openNav()">
        <i class="fas fa-bars"></i>
    </button>
</header>

<aside id="sidebar" class="app-sidebar">
    <div class="app-sidebar__header">
        <h3>Меню</h3>
        <button class="app-sidebar__close-btn" onclick="closeNav()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <nav class="app-sidebar__nav">
        <a th:href="@{/profile}" class="app-sidebar__nav-item">
            <i class="fas fa-user"></i>
            Личный кабинет
        </a>
        <a th:href="@{/products}" class="app-sidebar__nav-item">
            <i class="fas fa-box-open"></i>
            Номенклатура
        </a>
        <a href="/cart" class="app-sidebar__nav-item">
            <i class="fas fa-shopping-cart"></i>
            Корзина
        </a>
        <a th:href="@{/orders(username=${username})}" class="app-sidebar__nav-item">
            <i class="fas fa-clipboard-list"></i>
            Заказы
        </a>
        <a href="/documents" class="app-sidebar__nav-item">
            <i class="fas fa-file-alt"></i>
            Документация
        </a>
        <a th:href="@{/messenger}" class="app-sidebar__nav-item">
            <i class="fas fa-comments"></i>
            Мои обращения
        </a>
        <a th:href="@{/login}" class="app-sidebar__nav-item">
            <i class="fas fa-sign-out-alt"></i>
            Выйти
        </a>
    </nav>
</aside>

<main class="app-container">
    <section class="cart-section">
        <div class="cart-section__header">
            <h1 class="cart-section__title">Ваша корзина</h1>
            <div class="cart-section__actions" th:if="${cart != null and !cart.cartItems.isEmpty()}">
                <button id="manualDistributionBtn" class="distribution-btn">
                    <i class="fas fa-edit"></i> Редактирование
                </button>
                <button id="clearCartBtn" class="distribution-btn">
                    <i class="fas fa-trash"></i> Очистить корзину
                </button>
            </div>
        </div>

        <div th:if="${cart == null or cart.cartItems.isEmpty()}">
            <div class="cart-empty">
                <div class="cart-empty__icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h3 class="cart-empty__text">Ваша корзина пуста</h3>
                <a th:href="@{/products}" class="cart-empty__btn">
                    <i class="fas fa-arrow-left"></i> Перейти к товарам
                </a>
            </div>
        </div>

        <div th:if="${cart != null and !cart.cartItems.isEmpty()}" th:attr="data-cart-type=${isRailwayCart ? 'RAILWAY' : 'AUTO'}">
            <div th:each="truck, stat : ${cart.trucks}" class="truck-block animate-fade">
                <div class="truck-block__header">
                    <i class="fas fa-truck truck-block__icon"></i>
                    <span th:if="${isRailwayCart}">
                        <span th:text="'Вагон' + ' ' +  ${stat.count}"></span>
                    </span>
                    <span th:unless="${isRailwayCart}">
                        <span th:text="'Машина' + ' ' +  ${stat.count}"></span>
                    </span>
                </div>

                <div class="product-item" th:each="item : ${truck.items}">
                    <img th:src="@{/product/image/{id}(id=${item.product.images[0].id})}" class="product-item__image" alt="Product Image">
                    <div class="product-item__details">
                        <h3 class="product-item__name" th:text="${item.product.name}"></h3>
                        <div class="product-item__description">
                            <span class="product-item__spec">Сорт: <span th:text="${item.product.sort}"></span></span>
                            <span class="product-item__spec">Толщина: <span th:text="${#numbers.formatDecimal(item.product.tolsh, 1, 2)}"></span></span>
                            <span class="product-item__spec">Объем: <span th:text="${item.product.volume}"></span></span>
                            <span class="product-item__spec">Длина: <span th:text="${item.product.length}"></span></span>
                        </div>
                        <div class="product-item__price" th:data-product-id="${item.product.id}">
                            <span th:if="${item.sum != null}" th:text="${#numbers.formatDecimal(item.sum.summa, 1, 2)} + ' ₽'"></span>
                            <span th:unless="${item.sum != null}">Цена будет определена после выбора адреса доставки</span>
                        </div>

                        <div class="product-item__actions">
                            <div class="quantity-control" th:data-item-id="${item.product.id}" th:data-sum-id="${item.sum != null ? item.sum.id : ''}">
                                <button class="quantity-control__btn" onclick="decreaseQuantity(this)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <span class="quantity-control__value" th:text="${item.quantity}"></span>
                                <button class="quantity-control__btn" onclick="increaseQuantity(this)">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <aside class="checkout-section">

        <div class="order-summary">
            <div class="order-summary__header">
                <h3><i class="fas fa-receipt"></i> Итого</h3>
            </div>
            <div class="order-summary__total">
                <span>Общая сумма:</span>
                <span class="checkout-total" th:if="${cart != null}" th:text="${#numbers.formatDecimal(cartService.calculateCartTotal(cart), 1, 2)} + ' ₽'">0 ₽</span>
                <span class="checkout-total" th:unless="${cart != null}">0 ₽</span>
            </div>
        </div>
        <h2 class="checkout-section__title">
            <i class="fas fa-receipt"></i> Оформление заказа
        </h2>

        <form th:action="@{/cart/checkout}" method="post">
            <div class="form-group">
                <label for="addressId" class="form-label">Адрес доставки</label>
                <select id="addressId" name="addressId" class="form-control">
                    <option value="" data-schedule="">Выберите адрес</option>
                    <option th:each="address : ${addresses}"
                            th:value="${address.id}"
                            th:text="${address.postalcode + ', ' + address.country + ', ' + (address.clientsRegion != null ? address.clientsRegion.region.name : '') + ', ' + address.city + ', ' + address.street + ', ' + address.home + (address.roomnumber != null ? ', ' + address.roomnumber : '')}"
                            th:data-schedule="${address.schedule}">
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label for="schedule" class="form-label" >График работы адреса доставки</label>
                <input type="text" id="schedule" name="schedule" class="form-control" readonly>
            </div>


            <div class="form-group">
                <label for="deliveryDateTime" class="form-label">Дата доставки</label>
                <input type="datetime-local" id="deliveryDateTime" name="deliveryDateTime"
                       th:attr="min=${minDateTime}" class="form-control" required >
            </div>

            <div class="form-group">
                <label for="comment" class="form-label">Комментарий к заказу</label>
                <textarea id="comment" name="comment" class="form-control" rows="4" maxlength="2500"></textarea>
            </div>

            <button type="submit" class="btn">
                <i class="fas fa-check-circle"></i> Оформить заказ
            </button>
        </form>
    </aside>

</main>

<div id="manualDistributionModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Ручное распределение товаров</h3>
            <button class="modal-close">×</button>
        </div>
        <div class="modal-body">
            <div class="distribution-container">
                <div class="distribution-source">
                    <h4>Доступные товары</h4>
                    <div class="product-list dropzone" id="allProducts">
                        <!-- Товары будут добавлены через JS -->
                    </div>
                </div>

                <!-- Правая часть - машины -->
                <div class="distribution-target">
                    <div class="trucks-header">
                        <h4 id="trucksHeader">
                            <span th:if="${isRailwayCart}">Вагоны</span>
                            <span th:unless="${isRailwayCart}">Машины</span>
                        </h4>
                        <button id="autoDistributeBtn" class="btn btn--small auto-distribute-btn">
                            <i class="fas fa-magic"></i> Автораспределение
                        </button>
                    </div>
                    <div class="trucks-container" id="trucksContainer">
                        <!-- Машины будут добавлены через JS -->
                    </div>
                    <button id="addTruckBtn" class="btn btn--small">
                        <i class="fas fa-plus"></i> 
                        <span th:if="${isRailwayCart}">Добавить вагон</span>
                        <span th:unless="${isRailwayCart}">Добавить машину</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="saveDistributionBtn" class="btn">
                <i class="fas fa-save"></i> Сохранить распределение
            </button>
            <button id="cancelDistributionBtn" class="btn btn--secondary">
                <i class="fas fa-times"></i> Отмена
            </button>
        </div>
    </div>
</div>

<script th:inline="javascript">
    var quota = [[${activeQuota != null ? activeQuota.allowedVolume : 0}]];
</script>
<script>
    // Обработчики сайдбара
    function openNav() {
        document.getElementById("sidebar").classList.add("app-sidebar--open");
    }

    function closeNav() {
        document.getElementById("sidebar").classList.remove("app-sidebar--open");
    }

    document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.querySelector('.app-header__menu-btn');

        if (sidebar.classList.contains('app-sidebar--open') &&
            !sidebar.contains(event.target) &&
            event.target !== menuBtn &&
            !menuBtn.contains(event.target)) {
            closeNav();
        }
    });

    // Управление состоянием кнопки "Оформить заказ"
    function toggleCheckoutButton() {
        const priceElements = document.querySelectorAll('.product-item__price');
        const checkoutButton = document.querySelector('form button[type="submit"]');
        let allPricesSet = true;

        priceElements.forEach(priceElement => {
            if (priceElement.textContent.includes('Цена будет определена')) {
                allPricesSet = false;
            }
        });

        checkoutButton.disabled = !allPricesSet;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const addressSelect = document.getElementById('addressId');
        const scheduleInput = document.getElementById('schedule');

        // Устанавливаем пустой график по умолчанию
        if (scheduleInput) {
            scheduleInput.value = '';
        }

        // Восстанавливаем выбранный адрес из sessionStorage, если есть
        const savedAddressId = sessionStorage.getItem('selectedAddressId');
        if (savedAddressId && addressSelect) {
            addressSelect.value = savedAddressId;
            const selectedOption = addressSelect.options[addressSelect.selectedIndex];
            if (selectedOption && scheduleInput) {
                scheduleInput.value = selectedOption.getAttribute('data-schedule') || '';
            }
        }

        // Инициализируем состояние кнопки
        toggleCheckoutButton();

        if (addressSelect) {
            addressSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const schedule = selectedOption.getAttribute('data-schedule');
                const selectedAddressId = this.value;

                // Обновляем график доставки
                if (scheduleInput) {
                    scheduleInput.value = schedule || '';
                }

                // Сохраняем выбранный адрес в sessionStorage
                sessionStorage.setItem('selectedAddressId', selectedAddressId);

                // Если выбран пустой вариант, очищаем цены
                if (!selectedAddressId) {
                    document.querySelectorAll('.product-item__price').forEach(priceElement => {
                        priceElement.innerHTML = 'Цена будет определена после выбора адреса доставки';
                    });
                    document.querySelectorAll('.checkout-total').forEach(element => {
                        element.textContent = '0 ₽';
                    });
                    toggleCheckoutButton();
                    return;
                }

                // Обновляем цены
                fetch('/cart/updatePrices?addressId=' + selectedAddressId, {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content,
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            updatePricesOnPage(data.prices, data.total);
                            // Проверяем состояние кнопки после обновления цен
                            toggleCheckoutButton();
                        } else {
                            throw new Error(data.error || 'Ошибка при обновлении цен');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Ошибка при обновлении цен: ' + error.message);
                        // Восстанавливаем график, если запрос не удался
                        if (scheduleInput) {
                            scheduleInput.value = schedule || '';
                        }
                    });
            });
        }

        document.getElementById('clearCartBtn').addEventListener('click', function() {
            if (confirm('Вы уверены, что хотите полностью очистить корзину? Это действие нельзя отменить.')) {
                fetch('/cart/clear', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            sessionStorage.removeItem('selectedAddressId'); // Очищаем сохранённый адрес
                            location.reload();
                        } else {
                            throw new Error('Ошибка при очистке корзины');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert(error.message);
                    });
            }
        });
    });

    function updateQuantity(button, delta) {
        const container = button.closest('.quantity-control');
        const productId = container.getAttribute('data-item-id');
        const username = document.querySelector('meta[name="username"]').content;
        const addressId = document.getElementById('addressId').value;

        const url = new URL('/cart/updateQuantity', window.location.origin);
        url.searchParams.append('productId', productId);
        url.searchParams.append('username', username);
        url.searchParams.append('delta', delta);
        if (addressId) {
            url.searchParams.append('addressId', addressId);
        }

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    throw new Error('Ошибка при обновлении количества');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
    }

    function updatePricesOnPage(prices, total) {
        document.querySelectorAll('.product-item__price').forEach(priceElement => {
            const productId = priceElement.getAttribute('data-product-id');
            if (prices[productId]) {
                priceElement.innerHTML = Number(prices[productId].price).toFixed(2) + ' ₽';
                // Обновляем sumId в соответствующем контроле количества
                const quantityControl = document.querySelector(`.quantity-control[data-item-id="${productId}"]`);
                if (quantityControl) {
                    quantityControl.setAttribute('data-sum-id', prices[productId].sumId || '');
                }
            } else {
                priceElement.innerHTML = 'Цена будет определена после выбора адреса доставки';
            }
        });

        // Обновляем общую сумму
        const totalElements = document.querySelectorAll('.checkout-total');
        totalElements.forEach(element => {
            element.textContent = Number(total).toFixed(2) + ' ₽';
        });
    }

    function increaseQuantity(button) {
        updateQuantity(button, 1);
    }

    function decreaseQuantity(button) {
        updateQuantity(button, -1);
    }

    let draggedItem = null;

    document.getElementById('manualDistributionBtn').addEventListener('click', function() {
        const modal = document.getElementById('manualDistributionModal');
        modal.style.display = 'block';
        updateModalHeaders();
        loadManualDistributionData();
    });

    document.querySelector('.modal-close').addEventListener('click', closeManualDistributionModal);
    document.getElementById('cancelDistributionBtn').addEventListener('click', closeManualDistributionModal);

    function closeManualDistributionModal() {
        document.getElementById('manualDistributionModal').style.display = 'none';
    }

    async function loadManualDistributionData() {
        const allProductsContainer = document.getElementById('allProducts');
        const trucksContainer = document.getElementById('trucksContainer');

        allProductsContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i>Загрузка данных...</div>';
        trucksContainer.innerHTML = '';

        try {
            const response = await fetch('/cart/manualDistribution', {
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                }
            });

            if (!response.ok) {
                throw new Error('Ошибка загрузки данных');
            }

            const cartData = await response.json();

            allProductsContainer.innerHTML = '';
            if (cartData.trucks && cartData.trucks.length > 0) {
                cartData.trucks.forEach((truck, index) => {
                    const truckElement = createTruckElement(truck, index + 1);
                    trucksContainer.appendChild(truckElement);
                });
            } else {
                const truckElement = createTruckElement({items: []}, 1);
                trucksContainer.appendChild(truckElement);
            }
            initDragAndDrop();
        } catch (error) {
            console.error('Error:', error);
            allProductsContainer.innerHTML = `<div class="error">${error.message}</div>`;
        }
    }

    function createProductElement(item, isAvailableProduct = false) {
        const element = document.createElement('div');
        element.className = 'distribution-item';
        element.dataset.productId = item.productId;
        element.dataset.sumId = item.sumId;
        element.dataset.length = item.length;
        element.draggable = true;

        const splitButton = isAvailableProduct ?
            `<button class="split-btn" title="Разделить товар">
            <i class="fas fa-cut"></i>
        </button>` : '';

        element.innerHTML = `
        <div class="distribution-item-content">
            <span class="distribution-item__name">${item.productName}</span>
            <div class="distribution-item__actions">
                <div class="distribution-item__quantity">
                    <input type="number" class="quantity-input" value="${item.quantity}" min="1">
                    <span>шт.</span>
                </div>
                ${splitButton}
            </div>
        </div>
    `;

        if (isAvailableProduct) {
            element.querySelector('.split-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                splitProductItem(element);
            });
        }

        return element;
    }

    function splitProductItem(itemElement) {
        const quantityInput = itemElement.querySelector('.quantity-input');
        const currentQuantity = parseInt(quantityInput.value);

        if (currentQuantity <= 1) {
            alert('Нельзя разделить товар с количеством 1');
            return;
        }

        const half = Math.ceil(currentQuantity / 2);
        const remainder = currentQuantity - half;

        quantityInput.value = half;

        const newItem = itemElement.cloneNode(true);
        newItem.querySelector('.quantity-input').value = remainder;

        itemElement.parentNode.insertBefore(newItem, itemElement.nextSibling);
    }

    function createTruckElement(truck, truckNumber) {
        const element = document.createElement('div');
        element.className = 'truck';
        element.dataset.truckId = truck.id || Date.now();

        // Определяем тип номенклатуры для правильного заголовка
        const cartType = document.querySelector('[data-cart-type]')?.dataset.cartType;
        const isRailway = cartType === 'RAILWAY';
        const vehicleType = isRailway ? 'Вагон' : 'Машина';

        element.innerHTML = `
        <div class="truck-header">
            <span id="truckType-${truckNumber}">${vehicleType} ${truckNumber}</span>
            <i class="fas fa-trash delete-truck"></i>
        </div>
        <div class="truck-products dropzone" data-truck-id="${truck.id || Date.now()}">
            ${truck.items ? truck.items.map(item => `
                <div class="distribution-item"
                     data-product-id="${item.productId}"
                     data-sum-id="${item.sumId}"
                     data-length="${item.length}"
                     draggable="true">
                    <div class="distribution-item-content">
                        <span class="distribution-item__name">${item.productName}</span>
                        <div class="distribution-item__quantity">
                            <input type="number" class="quantity-input" value="${item.quantity}" min="1">
                            <span>шт.</span>
                        </div>
                    </div>
                </div>
            `).join('') : ''}
        </div>
    `;

        element.querySelector('.delete-truck').addEventListener('click', function() {
            const vehicleTypeText = isRailway ? 'вагон' : 'машину';
            if (confirm(`Удалить этот ${vehicleTypeText}? Товары будут перенесены в доступные.`)) {
                const items = element.querySelectorAll('.distribution-item');
                const allProducts = document.getElementById('allProducts');

                items.forEach(item => {
                    const productData = {
                        productId: item.dataset.productId,
                        sumId: item.dataset.sumId,
                        length: item.dataset.length,
                        productName: item.querySelector('.distribution-item__name').textContent,
                        quantity: parseInt(item.querySelector('.quantity-input').value)
                    };
                    const newItem = createProductElement(productData, true);
                    allProducts.appendChild(newItem);
                });

                element.remove();
                updateTruckNumbers();
            }
        });

        return element;
    }

    document.getElementById('addTruckBtn').addEventListener('click', function() {
        const trucksContainer = document.getElementById('trucksContainer');
        const truckElement = createTruckElement({items: []}, trucksContainer.children.length + 1);
        trucksContainer.appendChild(truckElement);
    });

    function updateTruckNumbers() {
        const trucks = document.querySelectorAll('.truck');
        trucks.forEach((truck, index) => {
            // Проверяем тип номенклатуры из корзины
            const cartType = document.querySelector('[data-cart-type]')?.dataset.cartType;
            const truckType = cartType === 'RAILWAY' ? 'Вагон' : 'Машина';
            truck.querySelector('.truck-header span').textContent = `${truckType} ${index + 1}`;
        });
    }

    // Обновляем заголовки в модальном окне
    function updateModalHeaders() {
        const cartType = document.querySelector('[data-cart-type]')?.dataset.cartType;
        const isRailway = cartType === 'RAILWAY';
        
        // Обновляем заголовок "Машины/Вагоны"
        const trucksHeader = document.getElementById('trucksHeader');
        if (trucksHeader) {
            trucksHeader.textContent = isRailway ? 'Вагоны' : 'Машины';
        }
        
        // Обновляем кнопку "Добавить машину/вагон"
        const addTruckBtn = document.getElementById('addTruckBtn');
        if (addTruckBtn) {
            const icon = addTruckBtn.querySelector('i');
            addTruckBtn.innerHTML = '';
            addTruckBtn.appendChild(icon);
            addTruckBtn.appendChild(document.createTextNode(isRailway ? ' Добавить вагон' : ' Добавить машину'));
        }
    }

    function initDragAndDrop() {
        document.addEventListener('dragstart', function(e) {
            if (e.target.classList.contains('distribution-item')) {
                draggedItem = e.target;
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.innerHTML);
            }
        });

        document.addEventListener('dragend', function(e) {
            if (e.target.classList.contains('distribution-item')) {
                e.target.classList.remove('dragging');
            }
        });

        document.addEventListener('dragover', function(e) {
            const dropzone = getDropzone(e.target);
            if (dropzone) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            }
        });

        document.addEventListener('dragenter', function(e) {
            const dropzone = getDropzone(e.target);
            if (dropzone) {
                e.preventDefault();
                dropzone.classList.add('dropzone-hover');
            }
        });

        document.addEventListener('dragleave', function(e) {
            const dropzone = getDropzone(e.target);
            if (dropzone) {
                dropzone.classList.remove('dropzone-hover');
            }
        });

        document.addEventListener('drop', function(e) {
            const dropzone = getDropzone(e.target);

            if (dropzone && draggedItem) {
                e.preventDefault();
                dropzone.classList.remove('dropzone-hover');

                if (draggedItem.parentNode !== dropzone) {
                    if (dropzone.id === 'allProducts') {
                        const productData = {
                            productId: draggedItem.dataset.productId,
                            sumId: draggedItem.dataset.sumId,
                            length: draggedItem.dataset.length,
                            productName: draggedItem.querySelector('.distribution-item__name').textContent,
                            quantity: parseInt(draggedItem.querySelector('.quantity-input').value)
                        };
                        const newItem = createProductElement(productData, true);
                        dropzone.appendChild(newItem);
                        draggedItem.remove();
                    } else if (dropzone.classList.contains('truck-products')) {
                        if (!validateTruckCapacity(dropzone, draggedItem)) {
                            return;
                        }
                        const existingItem = findExistingItem(dropzone, draggedItem);
                        if (existingItem) {
                            updateItemQuantity(existingItem, draggedItem);
                        } else {
                            const productData = {
                                productId: draggedItem.dataset.productId,
                                sumId: draggedItem.dataset.sumId,
                                length: draggedItem.dataset.length,
                                productName: draggedItem.querySelector('.distribution-item__name').textContent,
                                quantity: parseInt(draggedItem.querySelector('.quantity-input').value)
                            };
                            const newItem = createProductElement(productData, false);
                            dropzone.appendChild(newItem);
                            draggedItem.remove();
                        }
                    }
                }
            }
        });

        document.addEventListener('click', function(e) {
            if (e.target.closest('.split-btn')) {
                e.preventDefault();
                e.stopPropagation();
            }
        });
    }

    function getDropzone(element) {
        return element.classList.contains('dropzone')
            ? element
            : element.closest('.dropzone');
    }

    function validateTruckCapacity(dropzone, draggedItem) {
        const cartType = document.querySelector('[data-cart-type]')?.dataset.cartType;
        const isRailway = cartType === 'RAILWAY';
        
        const truckProducts = dropzone.querySelectorAll('.distribution-item');
        let totalItems = 0;
        let max = 16;
        const vehicleType = isRailway ? 'вагон' : 'машину';

        if (isRailway) {
            // Логика для ЖД товаров
            truckProducts.forEach(item => {
                const quantity = parseInt(item.querySelector('.quantity-input').value);
                totalItems += quantity;
            });
            const draggedQuantity = parseInt(draggedItem.querySelector('.quantity-input').value);
            totalItems += draggedQuantity;
            max = 49; // Максимум 49 пачек для ЖД
        } else {
            // Логика для авто товаров (существующая)
            let count25 = 0;
            let count28 = 0;
            truckProducts.forEach(item => {
                const quantity = parseInt(item.querySelector('.quantity-input').value);
                const length = parseFloat(item.dataset.length);
                totalItems += quantity;
                if (length === 2.5 || length === 2.4) count25 += quantity;
                if (length === 2.8) count28 += quantity;
            });
            const draggedQuantity = parseInt(draggedItem.querySelector('.quantity-input').value);
            const productLength = parseFloat(draggedItem.dataset.length);
            if (productLength === 2.5 || productLength === 2.4) count25 += draggedQuantity;
            if (productLength === 2.8) count28 += draggedQuantity;
            totalItems += draggedQuantity;
            
            if (count28 > 0 && count25 > 0) {
                max = (count28 > 7) ? 13 : 16;
            } else if (count28 > 0 && count25 === 0) {
                max = 13;
            } else if (count25 > 0 && count28 === 0) {
                max = 16;
            }
        }
        
        if (totalItems > max) {
            alert(`В ${vehicleType} можно добавить не более ${max} пачек по текущим правилам!`);
            return false;
        }
        return true;
    }

    function findExistingItem(dropzone, draggedItem) {
        return dropzone.querySelector(
            `[data-product-id="${draggedItem.dataset.productId}"][data-sum-id="${draggedItem.dataset.sumId}"]`
        );
    }

    function updateItemQuantity(existingItem, draggedItem) {
        const existingQuantity = parseInt(existingItem.querySelector('.quantity-input').value);
        const newQuantity = parseInt(draggedItem.querySelector('.quantity-input').value);
        existingItem.querySelector('.quantity-input').value = existingQuantity + newQuantity;
        draggedItem.remove();
    }

    document.getElementById('autoDistributeBtn').addEventListener('click', async function() {
        if (confirm('Выполнить автораспределение товаров? Текущее распределение будет сброшено.')) {
            try {
                const token = document.querySelector('meta[name="_csrf"]').content;
                const header = document.querySelector('meta[name="_csrf_header"]').content;

                const response = await fetch('/cart/autoDistribute', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': token,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Ошибка автораспределения');
                }

                loadManualDistributionData();
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }
    });

    document.getElementById('saveDistributionBtn').addEventListener('click', async function() {
        const trucks = [];
        const truckElements = document.querySelectorAll('.truck');
        let isValid = true;

        truckElements.forEach(truckElement => {
            const truck = {
                id: truckElement.dataset.truckId,
                items: []
            };

            let totalItems = 0;
            let longProductsCount = 0;

            truckElement.querySelectorAll('.distribution-item').forEach(item => {
                const quantity = parseInt(item.querySelector('.quantity-input').value);
                const length = parseFloat(item.dataset.length);

                totalItems += quantity;
                if (length === 2.8) {
                    longProductsCount += quantity;
                }

                truck.items.push({
                    productId: item.dataset.productId,
                    sumId: item.dataset.sumId,
                    quantity: quantity,
                    productName: item.querySelector('.distribution-item__name').textContent,
                    length: length
                });
            });

            // Валидация в зависимости от типа номенклатуры
            const cartType = document.querySelector('[data-cart-type]')?.dataset.cartType;
            const isRailway = cartType === 'RAILWAY';
            const truckType = isRailway ? 'Вагон' : 'Машина';
            const truckNumber = truckElement.querySelector('.truck-header span').textContent;
            
            if (isRailway) {
                // Логика для ЖД товаров
                if (totalItems > 49) {
                    alert(`${truckNumber} содержит ${totalItems} пачек. Максимум 49 пачек разрешено для ЖД товаров.`);
                    isValid = false;
                }
            } else {
                // Логика для авто товаров (существующая)
                if (longProductsCount >= 7 && totalItems > 13) {
                    alert(`${truckNumber} содержит ${totalItems} пачек при ${longProductsCount} длинных товарах. Максимум 13 пачек разрешено.`);
                    isValid = false;
                } else if (totalItems > 16) {
                    alert(`${truckNumber} содержит ${totalItems} пачек. Максимум 16 пачек разрешено.`);
                    isValid = false;
                }
            }

            trucks.push(truck);
        });

        if (!isValid) {
            return;
        }

        try {
            const token = document.querySelector('meta[name="_csrf"]').content;
            const header = document.querySelector('meta[name="_csrf_header"]').content;

            const response = await fetch('/cart/saveManualDistribution', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                },
                body: JSON.stringify({trucks})
            });

            if (!response.ok) {
                throw new Error(await response.text());
            }

            closeManualDistributionModal();
            location.reload();
        } catch (error) {
            console.error('Error:', error);
            alert('Ошибка сохранения: ' + error.message);
        }
    });

    function setupQuantityInputListeners() {
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', function() {
                const item = this.closest('.distribution-item');
                const dropzone = this.closest('.dropzone');

                if (dropzone.classList.contains('truck-products')) {
                    validateTruckQuantity(this);
                }
            });
        });
    }

    function validateTruckQuantity(input) {
        const truckProducts = input.closest('.truck-products');
        const items = truckProducts.querySelectorAll('.distribution-item');
        const cartType = document.querySelector('[data-cart-type]')?.dataset.cartType;

        let totalItems = 0;
        let max = 16;

        if (cartType === 'RAILWAY') {
            // Логика для ЖД товаров
            items.forEach(item => {
                const quantity = parseInt(item.querySelector('.quantity-input').value);
                totalItems += quantity;
            });
            max = 49;
        } else {
            // Логика для авто товаров (существующая)
            let count25 = 0;
            let count28 = 0;

            items.forEach(item => {
                const quantity = parseInt(item.querySelector('.quantity-input').value);
                const length = parseFloat(item.dataset.length);
                totalItems += quantity;
                if (length === 2.5 || length === 2.4) count25 += quantity;
                if (length === 2.8) count28 += quantity;
            });

            if (count28 > 0 && count25 > 0) {
                max = (count28 > 7) ? 13 : 16;
            } else if (count28 > 0 && count25 === 0) {
                max = 13;
            } else if (count25 > 0 && count28 === 0) {
                max = 16;
            }
        }

        if (totalItems > max) {
            const truckType = cartType === 'RAILWAY' ? 'вагон' : 'машину';
            alert(`В ${truckType} можно добавить не более ${max} пачек по текущим правилам!`);
            input.value = 1;
            validateTruckQuantity(input);
        }
    }

    // Валидация для обычной корзины (кнопки + и -)
    function validateCartQuantities() {
        const cartType = document.querySelector('[data-cart-type]')?.dataset.cartType;
        
        document.querySelectorAll('.truck-block').forEach(truckBlock => {
            let total = 0;
            let max = 16;

            if (cartType === 'RAILWAY') {
                // Логика для ЖД товаров
                truckBlock.querySelectorAll('.product-item').forEach(item => {
                    const quantity = parseInt(item.querySelector('.quantity-control__value').textContent);
                    total += quantity;
                });
                max = 49; // Максимум 49 пачек для ЖД
            } else {
                // Логика для авто товаров (существующая)
                let count25 = 0;
                let count28 = 0;
                truckBlock.querySelectorAll('.product-item').forEach(item => {
                    const quantity = parseInt(item.querySelector('.quantity-control__value').textContent);
                    const length = parseFloat(item.querySelector('.product-item__spec:last-child span').textContent);
                    total += quantity;
                    if (length === 2.5 || length === 2.4) count25 += quantity;
                    if (length === 2.8) count28 += quantity;
                });
                if (count28 > 0 && count25 > 0) {
                    max = (count28 > 7) ? 13 : 16;
                } else if (count28 > 0 && count25 === 0) {
                    max = 13;
                } else if (count25 > 0 && count28 === 0) {
                    max = 16;
                }
            }
            
            if (total > max) {
                const truckType = cartType === 'RAILWAY' ? 'вагоне' : 'машине';
                alert(`В ${truckType} не может быть больше ${max} пачек по текущим правилам!`);
                // Можно реализовать откат последнего действия или блокировку
            }
        });
    }

    // Проверка квоты при изменении количества в корзине
    function showQuotaNotification(message) {
        let n = document.getElementById('quota-notification');
        if (!n) {
            n = document.createElement('div');
            n.id = 'quota-notification';
            n.style.position = 'fixed';
            n.style.top = '30px';
            n.style.right = '30px';
            n.style.background = 'var(--error)';
            n.style.color = 'white';
            n.style.padding = '1rem 2rem';
            n.style.borderRadius = '8px';
            n.style.zIndex = 9999;
            n.style.fontWeight = '600';
            n.style.boxShadow = 'var(--shadow-md)';
            document.body.appendChild(n);
        }
        n.textContent = message;
        n.style.display = 'block';
        setTimeout(() => { n.style.display = 'none'; }, 2500);
    }

    function getCartTotalVolume() {
        let total = 0;
        document.querySelectorAll('.product-item').forEach(item => {
            const quantity = parseInt(item.querySelector('.quantity-control__value').textContent);
            const volume = parseFloat(item.querySelector('.product-item__spec:nth-child(3) span').textContent);
            if (!isNaN(quantity) && !isNaN(volume)) {
                total += quantity * volume;
            }
        });
        return total;
    }

    // Блокировка увеличения количества если превышена квота
    function increaseQuantity(btn) {
        const container = btn.closest('.quantity-control');
        const valueSpan = container.querySelector('.quantity-control__value');
        let quantity = parseInt(valueSpan.textContent);
        const item = btn.closest('.product-item');
        const volume = parseFloat(item.querySelector('.product-item__spec:nth-child(3) span').textContent);
        const currentTotal = getCartTotalVolume();
        if (currentTotal + volume > quota) {
            showQuotaNotification('Превышен объём по квоте!');
            return;
        }
        valueSpan.textContent = quantity + 1;
        updateQuantity(container, 1);
    }

    // Аналогично для ручного распределения (manual distribution)
    // Внутри перед отправкой запроса:
    // let total = 0;
    // document.querySelectorAll('.distribution-item').forEach(item => {
    //   const quantity = parseInt(item.querySelector('.quantity-input').value);
    //   const volume = parseFloat(item.dataset.volume); // предполагается, что volume есть в data-атрибуте
    //   total += quantity * volume;
    // });
    // if (total > quota) { showQuotaNotification('Превышен объём по квоте!'); return; }

    // --- Проверка квоты в ручном распределении ---
    const manualSaveBtn = document.getElementById('saveDistributionBtn');
    if (manualSaveBtn) {
        manualSaveBtn.addEventListener('click', function(e) {
            let total = 0;
            document.querySelectorAll('.truck-products .distribution-item').forEach(item => {
                const quantity = parseInt(item.querySelector('.quantity-input').value);
                const volume = parseFloat(item.dataset.length);
                total += quantity * volume;
            });
            if (total > quota) {
                showQuotaNotification('Превышен объём по квоте!');
                e.preventDefault();
                return false;
            }
        });
    }
    // --- Блокировка кнопки оформления заказа ---
    function checkCheckoutButton() {
        const checkoutBtn = document.querySelector('form button[type="submit"]');
        if (!checkoutBtn) return;
        const cartTotal = getCartTotalVolume();
        if (quota <= 0.01 || cartTotal > quota) {
            checkoutBtn.disabled = true;
            checkoutBtn.style.opacity = '0.5';
            checkoutBtn.style.cursor = 'not-allowed';
            if (!document.getElementById('checkout-quota-warning')) {
                const warn = document.createElement('div');
                warn.id = 'checkout-quota-warning';
                warn.style.color = 'var(--error)';
                warn.style.fontWeight = '600';
                warn.style.margin = '0.5rem 0';
                warn.textContent = 'Оформление заказа недоступно: превышен объём по квоте или квота отсутствует';
                checkoutBtn.parentNode.insertBefore(warn, checkoutBtn.nextSibling);
            }
        } else {
            checkoutBtn.disabled = false;
            checkoutBtn.style.opacity = '1';
            checkoutBtn.style.cursor = '';
            const warn = document.getElementById('checkout-quota-warning');
            if (warn) warn.remove();
        }
    }
    document.addEventListener('DOMContentLoaded', checkCheckoutButton);
    document.addEventListener('input', checkCheckoutButton);
</script>
</body>
</html>